<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Control de Acceso</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .login-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .form-input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.5);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-button {
            padding: 12px 24px;
            border: none;
            background: transparent;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #64748b;
        }

        .tab-button.active {
            color: #4CAF50;
            border-bottom-color: #4CAF50;
        }

        .user-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #f1f5f9;
            transition: all 0.3s ease;
        }

        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }

        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-authorized {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .badge-visitor {
            background: #fff3e0;
            color: #ef6c00;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }

        .alert-error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }

        .hidden {
            display: none !important;
        }

        .grid-responsive {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }
    </style>
    <script src="env-config.js"></script>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center px-4">
        <div class="login-container glass-effect">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Panel de Administraci√≥n</h1>
                <p class="text-gray-600">Sistema de Control de Acceso</p>
            </div>
            
            <form id="loginForm">
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Usuario</label>
                    <input type="text" id="username" class="form-input" placeholder="Ingrese su usuario" required>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Contrase√±a</label>
                    <input type="password" id="password" class="form-input" placeholder="Ingrese su contrase√±a" required>
                </div>
                
                <button type="submit" class="btn-primary w-full">
                    Iniciar Sesi√≥n
                </button>
            </form>
            
            <div id="loginMessage" class="mt-4 hidden"></div>
            
            <div class="mt-8 text-center">
                <a href="/" class="text-blue-600 hover:text-blue-800 font-medium">
                    ‚Üê Volver al Control de Acceso
                </a>
            </div>
        </div>
    </div>

    <!-- Dashboard Screen -->
    <div id="dashboardScreen" class="hidden min-h-screen px-4 py-8">
        <button class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</button>
        
        <div class="dashboard-container glass-effect">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Panel de Administraci√≥n</h1>
                <p class="text-gray-600">Gesti√≥n de Usuarios y Visitantes</p>
            </div>
            
            <!-- Navigation Tabs -->
            <div class="flex justify-center mb-8 border-b">
                <button class="tab-button active" onclick="showTab('users')">
                    üë• Todos los Usuarios
                </button>
                <button class="tab-button" onclick="showTab('visitors')">
                    üèÉ Visitantes
                </button>
                <button class="tab-button" onclick="showTab('authorized')">
                    ‚úÖ Usuarios Autorizados
                </button>
                <button class="tab-button" onclick="showTab('register')">
                    ‚ûï Registrar Usuario
                </button>
            </div>
            
            <!-- Alert Messages -->
            <div id="alertContainer"></div>
            
            <!-- Users Tab -->
            <div id="usersTab" class="tab-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Todos los Usuarios</h2>
                <div id="usersGrid" class="grid-responsive"></div>
            </div>
            
            <!-- Visitors Tab -->
            <div id="visitorsTab" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Visitantes Registrados</h2>
                <div id="visitorsGrid" class="grid-responsive"></div>
            </div>
            
            <!-- Authorized Tab -->
            <div id="authorizedTab" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Usuarios Autorizados</h2>
                <div id="authorizedGrid" class="grid-responsive"></div>
            </div>
            
            <!-- Register Tab -->
            <div id="registerTab" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Registrar Nuevo Usuario</h2>
                
                <div class="max-w-2xl mx-auto">
                    <form id="registerForm" class="bg-white p-8 rounded-2xl shadow-lg">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Nombre Completo</label>
                                <input type="text" id="regName" class="form-input" placeholder="Ingrese el nombre" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Tipo de Usuario</label>
                                <select id="regUserType" class="form-input" onchange="toggleVisitorFields()">
                                    <option value="Authorized">Usuario Autorizado</option>
                                    <option value="Visitant">Visitante</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Common RUT field for all users -->
                        <div class="mt-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">RUT (Opcional)</label>
                                    <input type="text" id="regRut" class="form-input" placeholder="12.345.678-9" maxlength="12">
                                    <div id="regRutError" class="text-red-500 text-sm mt-1 hidden">RUT inv√°lido</div>
                                </div>
                                
                                <!-- Visitor specific field -->
                                <div id="visitorMotiveField" class="hidden">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Motivo de Visita</label>
                                    <input type="text" id="regMotive" class="form-input" placeholder="Descripci√≥n del motivo">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Fotograf√≠a</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center">
                                <!-- Camera Section -->
                                <div id="cameraSection">
                                    <video id="adminVideo" width="320" height="240" autoplay muted class="mx-auto rounded-lg mb-4 hidden"></video>
                                    <canvas id="adminCanvas" width="320" height="240" class="hidden"></canvas>
                                    <div id="photoPreview" class="hidden mb-4">
                                        <img id="capturedPhoto" width="320" height="240" class="mx-auto rounded-lg">
                                    </div>
                                    <div class="space-x-4">
                                        <button type="button" id="startCameraBtn" class="btn-secondary" onclick="startCamera()">
                                            üì∑ Iniciar C√°mara
                                        </button>
                                        <button type="button" id="captureBtn" class="btn-primary hidden" onclick="capturePhoto()">
                                            üì∏ Capturar Foto
                                        </button>
                                        <button type="button" id="retakeBtn" class="btn-secondary hidden" onclick="retakePhoto()">
                                            üîÑ Tomar Otra
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- File Upload Section -->
                                <div class="mt-4 pt-4 border-t border-gray-200">
                                    <p class="text-gray-600 mb-2">O subir archivo:</p>
                                    <input type="file" id="regPhoto" accept="image/*" class="form-input">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-8 text-center">
                            <button type="submit" class="btn-primary px-8 py-3">
                                ‚úÖ Registrar Usuario
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isLoggedIn = false;
        let adminStream = null;
        let capturedBlob = null;

        // Login functionality
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch('http://127.0.0.1:8000/admin/login/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                if (response.ok) {
                    isLoggedIn = true;
                    showAlert('¬°Inicio de sesi√≥n exitoso!', 'success');
                    setTimeout(() => {
                        document.getElementById('loginScreen').classList.add('hidden');
                        document.getElementById('dashboardScreen').classList.remove('hidden');
                        loadAllUsers();
                    }, 1000);
                } else {
                    showAlert('Usuario o contrase√±a incorrectos', 'error');
                }
            } catch (error) {
                showAlert('Error de conexi√≥n. Intente nuevamente.', 'error');
            }
        });

        // Logout functionality
        function logout() {
            isLoggedIn = false;
            document.getElementById('dashboardScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('loginForm').reset();
            stopCamera();
        }

        // Tab functionality
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            event.target.classList.add('active');
            
            // Load data based on tab
            if (tabName === 'users') {
                loadAllUsers();
            } else if (tabName === 'visitors') {
                loadVisitors();
            } else if (tabName === 'authorized') {
                loadAuthorized();
            }
        }

        // Load all users
        async function loadAllUsers() {
            try {
                const response = await fetch('http://127.0.0.1:8000/admin/users/');
                const result = await response.json();
                
                if (result.status === 'success') {
                    displayUsers(result.users, 'usersGrid');
                }
            } catch (error) {
                showAlert('Error al cargar usuarios', 'error');
            }
        }

        // Load visitors only
        async function loadVisitors() {
            try {
                const response = await fetch('http://127.0.0.1:8000/admin/users/');
                const result = await response.json();
                
                if (result.status === 'success') {
                    const visitors = result.users.filter(user => user.user_type === 'Visitant');
                    displayUsers(visitors, 'visitorsGrid');
                }
            } catch (error) {
                showAlert('Error al cargar visitantes', 'error');
            }
        }

        // Load authorized users only
        async function loadAuthorized() {
            try {
                const response = await fetch('http://127.0.0.1:8000/admin/users/');
                const result = await response.json();
                
                if (result.status === 'success') {
                    const authorized = result.users.filter(user => user.user_type === 'Authorized');
                    displayUsers(authorized, 'authorizedGrid');
                }
            } catch (error) {
                showAlert('Error al cargar usuarios autorizados', 'error');
            }
        }

        // Display users in grid
        function displayUsers(users, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (users.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-12">No hay usuarios registrados</div>';
                return;
            }
            
            users.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                
                const badgeClass = user.user_type === 'Authorized' ? 'badge-authorized' : 'badge-visitor';
                const isVisitor = user.user_type === 'Visitant';
                
                userCard.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">${user.name}</h3>
                            <span class="badge ${badgeClass}">${user.user_type}</span>
                        </div>
                        <button class="btn-danger" onclick="deleteUser('${user.id}', '${user.name}')">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                    
                    <div class="space-y-2 text-sm text-gray-600">
                        ${user.rut ? `<div><strong>RUT:</strong> ${user.rut}</div>` : ''}
                        ${isVisitor && user.motive ? `<div><strong>Motivo:</strong> ${user.motive}</div>` : ''}
                    </div>
                    
                    <div class="mt-4 text-xs text-gray-500">
                        Registrado: ${new Date(user.created_at).toLocaleString('es-ES')}
                    </div>
                `;
                
                container.appendChild(userCard);
            });
        }

        // Delete user
        async function deleteUser(userId, userName) {
            if (!confirm(`¬øEst√° seguro de que desea eliminar a "${userName}"?`)) return;
            
            try {
                const response = await fetch(`http://127.0.0.1:8000/admin/users/${userId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert(`Usuario "${userName}" eliminado exitosamente`, 'success');
                    loadAllUsers(); // Refresh current view
                } else {
                    showAlert('Error al eliminar usuario', 'error');
                }
            } catch (error) {
                showAlert('Error al eliminar usuario', 'error');
            }
        }

        // Toggle visitor fields
        function toggleVisitorFields() {
            const userType = document.getElementById('regUserType').value;
            const motiveField = document.getElementById('visitorMotiveField');
            
            if (userType === 'Visitant') {
                motiveField.classList.remove('hidden');
            } else {
                motiveField.classList.add('hidden');
            }
        }

        // Camera functionality
        async function startCamera() {
            try {
                adminStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 320, height: 240 }
                });
                
                const video = document.getElementById('adminVideo');
                video.srcObject = adminStream;
                video.classList.remove('hidden');
                
                document.getElementById('startCameraBtn').classList.add('hidden');
                document.getElementById('captureBtn').classList.remove('hidden');
                
                showAlert('C√°mara iniciada correctamente', 'success');
            } catch (error) {
                showAlert('Error al acceder a la c√°mara', 'error');
            }
        }

        function capturePhoto() {
            const video = document.getElementById('adminVideo');
            const canvas = document.getElementById('adminCanvas');
            const ctx = canvas.getContext('2d');
            
            ctx.drawImage(video, 0, 0, 320, 240);
            
            canvas.toBlob((blob) => {
                capturedBlob = blob;
                
                const preview = document.getElementById('photoPreview');
                const img = document.getElementById('capturedPhoto');
                img.src = URL.createObjectURL(blob);
                preview.classList.remove('hidden');
                
                document.getElementById('captureBtn').classList.add('hidden');
                document.getElementById('retakeBtn').classList.remove('hidden');
                
                stopCamera();
                showAlert('Foto capturada exitosamente', 'success');
            }, 'image/jpeg', 0.8);
        }

        function retakePhoto() {
            document.getElementById('photoPreview').classList.add('hidden');
            document.getElementById('retakeBtn').classList.add('hidden');
            capturedBlob = null;
            startCamera();
        }

        function stopCamera() {
            if (adminStream) {
                adminStream.getTracks().forEach(track => track.stop());
                adminStream = null;
                
                const video = document.getElementById('adminVideo');
                video.classList.add('hidden');
                video.srcObject = null;
                
                document.getElementById('startCameraBtn').classList.remove('hidden');
                document.getElementById('captureBtn').classList.add('hidden');
            }
        }

        // Register user form
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('regName').value;
            const userType = document.getElementById('regUserType').value;
            const rut = document.getElementById('regRut').value;
            const motive = document.getElementById('regMotive').value;
            const photoFile = document.getElementById('regPhoto').files[0];
            
            // Validation
            if (userType === 'Visitant' && rut && !validateRUT(rut)) {
                document.getElementById('regRutError').classList.remove('hidden');
                return;
            } else {
                document.getElementById('regRutError').classList.add('hidden');
            }
            
            if (!capturedBlob && !photoFile) {
                showAlert('Debe capturar una foto o subir un archivo', 'error');
                return;
            }
            
            // Prepare form data
            const formData = new FormData();
            formData.append('name', name);
            formData.append('user_type', userType);
            
            // Add RUT for all users if provided
            if (rut) formData.append('rut', rut);
            
            // Add motive only for visitors
            if (userType === 'Visitant' && motive) {
                formData.append('motive', motive);
            }
            
            if (capturedBlob) {
                formData.append('file', capturedBlob, 'captured.jpg');
            } else {
                formData.append('file', photoFile);
            }
            
            try {
                const response = await fetch('http://127.0.0.1:8000/register/', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showAlert(result.message, 'success');
                    document.getElementById('registerForm').reset();
                    document.getElementById('visitorMotiveField').classList.add('hidden');
                    document.getElementById('photoPreview').classList.add('hidden');
                    stopCamera();
                    capturedBlob = null;
                    loadAllUsers();
                } else {
                    showAlert(result.message || 'Error al registrar usuario', 'error');
                }
            } catch (error) {
                showAlert('Error de conexi√≥n', 'error');
            }
        });

        // RUT validation
        function validateRUT(rut) {
            rut = rut.replace(/\./g, '').replace('-', '');
            if (rut.length < 8 || rut.length > 9) return false;
            
            const body = rut.slice(0, -1);
            const dv = rut.slice(-1).toUpperCase();
            
            if (!/^\d+$/.test(body)) return false;
            
            let sum = 0;
            let multiplier = 2;
            
            for (let i = body.length - 1; i >= 0; i--) {
                sum += parseInt(body[i]) * multiplier;
                multiplier = multiplier === 7 ? 2 : multiplier + 1;
            }
            
            const remainder = sum % 11;
            const calculatedDV = remainder === 0 ? '0' : remainder === 1 ? 'K' : (11 - remainder).toString();
            
            return dv === calculatedDV;
        }

        // Format RUT input
        document.getElementById('regRut').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^0-9kK]/g, '');
            
            if (value.length > 1) {
                const body = value.slice(0, -1);
                const dv = value.slice(-1);
                const formattedBody = body.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                value = formattedBody + '-' + dv;
            }
            
            e.target.value = value;
            document.getElementById('regRutError').classList.add('hidden');
        });

        // Show alert messages
        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(alertDiv);
            
            if (type === 'success') {
                setTimeout(() => {
                    alertDiv.remove();
                }, 5000);
            }
        }

        // Show login alert
        function showAlert(message, type) {
            const loginMessage = document.getElementById('loginMessage');
            if (loginMessage) {
                loginMessage.className = `alert alert-${type}`;
                loginMessage.textContent = message;
                loginMessage.classList.remove('hidden');
                
                if (type === 'success') {
                    setTimeout(() => {
                        loginMessage.classList.add('hidden');
                    }, 3000);
                }
            } else {
                // For dashboard alerts
                const container = document.getElementById('alertContainer');
                if (container) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = `alert alert-${type}`;
                    alertDiv.textContent = message;
                    
                    container.innerHTML = '';
                    container.appendChild(alertDiv);
                    
                    if (type === 'success') {
                        setTimeout(() => {
                            alertDiv.remove();
                        }, 5000);
                    }
                }
            }
        }
    </script>
</body>
</html>
